<!-- Top Bar -->
<header class="topbar border-bottom bg-body-tertiary">
  <div class="d-flex align-items-center justify-content-between">
    <!-- Left Section: Mobile Toggle for small screens -->
    <div class="topbar-left px-3">
      <!-- Mobile Menu Toggle (visible only on mobile) -->
      <button class="btn btn-link p-0 d-xl-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileSidebar" aria-controls="mobileSidebar" aria-label="Toggle navigation">
        {% uj_icon "bars", "fa-3xl text-body" %}
      </button>
    </div>

    <!-- Right Section: Actions & User Menu -->
    <div class="topbar-right d-flex align-items-center gap-2 px-3 py-2">
      <!-- Search (optional) -->
      {% if data.search %}
        <div class="d-none d-md-block">
          <form class="position-relative" action="{{ data.search.action | default: '/search' }}" method="get">
            <input
              type="search"
              name="{{ data.search.name | default: 'q' }}"
              class="form-control form-control-sm pe-5"
              placeholder="{{ data.search.placeholder | default: 'Search...' }}"
              style="min-width: 200px;"
            />
            <button type="submit" class="btn btn-link position-absolute end-0 top-50 translate-middle-y pe-2" style="border: none;">
              {% uj_icon "magnifying-glass", "fa-sm text-muted" %}
            </button>
          </form>
        </div>
      {% endif %}

      <!-- Custom Actions -->
      {% for action in data.actions %}
        {% if action.type == 'notifications' %}
          <!-- Notifications Dropdown -->
          {% capture action_attributes %}{% if action.attributes %}{% for attr in action.attributes %} {{ attr[0] }}="{{ attr[1] }}"{% endfor %}{% endif %}{% endcapture %}
          <div class="dropdown">
            <button class="btn btn-link position-relative p-2" type="button" data-bs-toggle="dropdown" {{ action_attributes }} aria-expanded="false">
              {% uj_icon action.icon | default: "bell", "fa-lg text-body" %}
              {% if action.badge %}
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill {{ action.badge.class | default: 'bg-danger' }}">
                  {{ action.badge.text }}
                  <span class="visually-hidden">unread notifications</span>
                </span>
              {% endif %}
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow" style="min-width: 320px; max-height: 400px; overflow-y: auto;">
              <li class="px-3 py-2 border-bottom">
                <div class="d-flex align-items-center justify-content-between">
                  <h6 class="mb-0">{{ action.label | default: 'Notifications' }}</h6>
                  {% if action.mark_all_read %}
                    <a href="{{ action.mark_all_read }}" class="small text-decoration-none">Mark all read</a>
                  {% endif %}
                </div>
              </li>
              {% if action.dropdown %}
                {% for notification in action.dropdown %}
                  {% capture notif_attributes %}{% if notification.attributes %}{% for attr in notification.attributes %} {{ attr[0] }}="{{ attr[1] }}"{% endfor %}{% endif %}{% endcapture %}
                  {% capture notif_class %}dropdown-item px-3 py-2 {% if notification.unread %}bg-body-secondary{% endif %} {% if notification.class %}{{ notification.class }}{% endif %}{% endcapture %}

                  {% if notification.divider %}
                    <li><hr class="dropdown-divider" {{ notif_attributes }}/></li>
                  {% else %}
                    <li>
                      {% iftruthy notification.href %}
                        <a class="{{ notif_class }}" href="{{ notification.href }}" {{ notif_attributes }}>
                          <div class="d-flex">
                            {% if notification.icon %}
                              <div class="me-3">
                                {% uj_icon notification.icon, "fa-lg {{ notification.icon_class | default: 'text-primary' }}" %}
                              </div>
                            {% endif %}
                            <div class="flex-fill">
                              <div class="fw-semibold small">{{ notification.title }}</div>
                              {% if notification.message %}
                                <div class="small text-muted">{{ notification.message }}</div>
                              {% endif %}
                              {% if notification.time %}
                                <div class="small text-muted mt-1">{{ notification.time }}</div>
                              {% endif %}
                            </div>
                          </div>
                        </a>
                      {% endiftruthy %}
                      {% iffalsy notification.href %}
                        <div class="{{ notif_class }}" {{ notif_attributes }}>
                          <div class="d-flex">
                            {% if notification.icon %}
                              <div class="me-3">
                                {% uj_icon notification.icon, "fa-lg {{ notification.icon_class | default: 'text-primary' }}" %}
                              </div>
                            {% endif %}
                            <div class="flex-fill">
                              <div class="fw-semibold small">{{ notification.title }}</div>
                              {% if notification.message %}
                                <div class="small text-muted">{{ notification.message }}</div>
                              {% endif %}
                              {% if notification.time %}
                                <div class="small text-muted mt-1">{{ notification.time }}</div>
                              {% endif %}
                            </div>
                          </div>
                        </div>
                      {% endiffalsy %}
                    </li>
                  {% endif %}
                {% endfor %}
              {% else %}
                <li class="px-3 py-4 text-center text-muted small">
                  No notifications
                </li>
              {% endif %}
            </ul>
          </div>
        {% elsif action.type == 'account' %}
          <!-- Account Dropdown -->
          {% capture action_attributes %}{% if action.attributes %}{% for attr in action.attributes %} {{ attr[0] }}="{{ attr[1] }}"{% endfor %}{% endif %}{% endcapture %}
          <div class="dropdown" data-wm-bind="@show auth.user" hidden>
            <button class="p-0 border-0 bg-transparent" type="button" data-bs-toggle="dropdown" {{ action_attributes }} aria-expanded="false">
              <div class="d-flex align-items-center">
                <span class="position-relative d-inline-block">
                  <span class="avatar avatar-md rounded-circle bg-secondary bg-opacity-10 border d-flex align-items-center justify-content-center overflow-hidden">
                    <img src="{{ site.uj.placeholder.src }}" data-wm-bind="@attr src auth.user.photoURL" alt="{{ site.brand.name }} profile picture"/>
                  </span>
                  <!-- Active status indicator -->
                  <span class="position-absolute bottom-0 end-0 p-1 bg-success border border-2 border-white avatar avatar-2xs rounded-circle">
                    <span class="visually-hidden">Active status</span>
                  </span>
                </span>
                <!-- <span class="ms-2 d-none d-md-inline-block">
                  <div class="small fw-semibold text-body" data-wm-bind="@text auth.user.displayName">User</div>
                </span> -->
              </div>
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow" style="min-width: 280px;">
              <!-- User info header -->
              <li>
                <a href="/account#profile" class="dropdown-item px-3 py-2 text-decoration-none">
                  <div class="d-flex align-items-center">
                    <div class="position-relative me-3">
                      <div class="avatar avatar-md rounded-circle bg-secondary bg-opacity-10 border d-flex align-items-center justify-content-center overflow-hidden">
                        <img src="{{ site.uj.placeholder.src }}" data-wm-bind="@attr src auth.user.photoURL" alt="{{ site.brand.name }} profile picture"/>
                      </div>
                      <span class="position-absolute bottom-0 end-0 p-1 bg-success border border-2 border-white avatar avatar-2xs rounded-circle">
                        <span class="visually-hidden">Active status</span>
                      </span>
                    </div>
                    <div class="flex-grow-1 overflow-hidden">
                      <div class="fw-semibold text-truncate text-body" data-wm-bind="@text auth.user.displayName">User</div>
                      <div class="small text-muted text-truncate" data-wm-bind="@text auth.user.email">email@example.com</div>
                    </div>
                  </div>
                </a>
              </li>

              <!-- Dropdown items -->
              {% if action.dropdown %}
                {% for child in action.dropdown %}
                  {% capture child_attributes %}{% if child.attributes %}{% for attr in child.attributes %} {{ attr[0] }}="{{ attr[1] }}"{% endfor %}{% endif %}{% endcapture %}
                  {% capture child_active %}{% urlmatches child.href, "active" %}{% endcapture %}
                  {% capture child_class %}dropdown-item d-flex align-items-center text-body {{ child_active }} {% if child.class %}{{ child.class }}{% endif %}{% endcapture %}
                  {% capture child_content %}
                    {% if child.icon %}
                      {% uj_icon child.icon, "fa-md me-3" %}
                    {% endif %}
                    <span>{{ child.label }}</span>
                  {% endcapture %}

                  {% if child.divider %}
                    <li><hr class="dropdown-divider" {{ child_attributes }}/></li>
                  {% else %}
                    <li>
                      {% iftruthy child.href %}
                        <a class="{{ child_class }}" href="{{ child.href }}" {{ child_attributes }}>
                          {{ child_content }}
                        </a>
                      {% endiftruthy %}
                      {% iffalsy child.href %}
                        <button class="{{ child_class }}" type="button" {{ child_attributes }}>
                          {{ child_content }}
                        </button>
                      {% endiffalsy %}
                    </li>
                  {% endif %}
                {% endfor %}
              {% endif %}
            </ul>
          </div>
        {% elsif action.dropdown %}
          <!-- Generic Dropdown -->
          {% capture action_class %}btn {% if action.size %}btn-{{ action.size }}{% endif %} {% if action.class %}{{ action.class }}{% else %}btn-adaptive{% endif %}{% endcapture %}
          {% capture action_attributes %}{% if action.attributes %}{% for attr in action.attributes %} {{ attr[0] }}="{{ attr[1] }}"{% endfor %}{% endif %}{% endcapture %}
          <div class="dropdown">
            <button class="{{ action_class }} dropdown-toggle" type="button" data-bs-toggle="dropdown" {{ action_attributes }}>
              {% if action.icon %}
                {% uj_icon action.icon, "fa-md me-2" %}
              {% endif %}
              <span>{{ action.label }}</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              {% for child in action.dropdown %}
                {% capture child_attributes %}{% if child.attributes %}{% for attr in child.attributes %} {{ attr[0] }}="{{ attr[1] }}"{% endfor %}{% endif %}{% endcapture %}
                {% capture child_active %}{% urlmatches child.href, "active" %}{% endcapture %}
                {% capture child_class %}dropdown-item text-body {{ child_active }} {% if child.class %}{{ child.class }}{% endif %}{% endcapture %}
                {% capture child_content %}
                  {% if child.icon %}
                    {% uj_icon child.icon, "fa-md me-2" %}
                  {% endif %}
                  <span>{{ child.label }}</span>
                {% endcapture %}

                {% if child.divider %}
                  <li><hr class="dropdown-divider" {{ child_attributes }}/></li>
                {% else %}
                  <li>
                    {% iftruthy child.href %}
                      <a class="{{ child_class }}" href="{{ child.href }}" {{ child_attributes }}>
                        {{ child_content }}
                      </a>
                    {% endiftruthy %}
                    {% iffalsy child.href %}
                      <button class="{{ child_class }}" type="button" {{ child_attributes }}>
                        {{ child_content }}
                      </button>
                    {% endiffalsy %}
                  </li>
                {% endif %}
              {% endfor %}
            </ul>
          </div>
        {% else %}
          <!-- Regular Button -->
          {% capture action_class %}btn {% if action.size %}btn-{{ action.size }}{% endif %} {% if action.class %}{{ action.class }}{% else %}btn-adaptive{% endif %}{% endcapture %}
          {% capture action_attributes %}{% if action.attributes %}{% for attr in action.attributes %} {{ attr[0] }}="{{ attr[1] }}"{% endfor %}{% endif %}{% endcapture %}
          {% capture action_content %}
            {% if action.icon %}
              {% uj_icon action.icon, "fa-md me-2" %}
            {% endif %}
            <span>{{ action.label }}</span>
          {% endcapture %}
          {% iftruthy action.href %}
            <a class="{{ action_class }}" href="{{ action.href }}" {{ action_attributes }}>
              {{ action_content }}
            </a>
          {% endiftruthy %}
          {% iffalsy action.href %}
            <button class="{{ action_class }}" type="button" {{ action_attributes }}>
              {{ action_content }}
            </button>
          {% endiffalsy %}
        {% endif %}
      {% endfor %}
    </div>
  </div>
</header>
